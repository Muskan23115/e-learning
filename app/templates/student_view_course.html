
<video controls width="100%" id="courseVideoPlayer" crossorigin="anonymous">
    

    <source src="/{{ course.video_url }}?v={{ range(1, 10000) | random }}" type="video/mp4">

    {% if subtitle_file %}
    <track
        kind="subtitles"
        label="{{ lang_name }}"
        src="{{ url_for('static', filename='subtitles/' + subtitle_file) }}?v={{ range(1, 10000) | random }}"
        srclang="{{ lang_code }}"
        default>
    {% endif %}
    
    {% if english_subtitle_file %}
    <track
        kind="subtitles"
        label="English"
        src="{{ url_for('static', filename='subtitles/' + english_subtitle_file) }}?v={{ range(1, 10000) | random }}"
        srclang="en">
    {% endif %}
  
    Your browser does not support the video tag.
</video>

<select id="captionSelect" style="margin-top: 15px; padding: 8px;"></select>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const video = document.getElementById('courseVideoPlayer');
        const captionSelect = document.getElementById('captionSelect');

        function setupCaptionMenu() {
            const tracks = video.textTracks;
            if (!tracks || tracks.length === 0) {
                captionSelect.style.display = 'none';
                return;
            }

            const currentSelectedValue = captionSelect.value;

            captionSelect.innerHTML = '';

            for (let i = 0; i < tracks.length; i++) {
                const track = tracks[i];
                const option = document.createElement('option');
                option.value = i;
                option.textContent = track.label;
                captionSelect.appendChild(option);
            }

            const noCapOption = document.createElement('option');
            noCapOption.value = 'none';
            noCapOption.textContent = 'No Captions';
            captionSelect.appendChild(noCapOption);

            if (currentSelectedValue) {
                captionSelect.value = currentSelectedValue;
            } else {
                let defaultTrackIndex = -1;
                for (let i = 0; i < tracks.length; i++) {
                    if (tracks[i].mode === 'showing') {
                        defaultTrackIndex = i;
                        break;
                    }
                }
                captionSelect.value = defaultTrackIndex !== -1 ? defaultTrackIndex : 'none';
            }
            
            captionSelect.style.display = 'inline-block';
        }

        captionSelect.addEventListener('change', function() {
            const tracks = video.textTracks;
            for (let i = 0; i < tracks.length; i++) {
                tracks[i].mode = 'hidden'; 
            }
            if (this.value !== 'none') {
                tracks[parseInt(this.value)].mode = 'showing'; 
            }
        });


        let checkCount = 0;
        const interval = setInterval(() => {
           
            if (video.textTracks.length >= 2 || checkCount > 25) {
                setupCaptionMenu();
                clearInterval(interval); 
            }
            checkCount++;
        }, 200); 
    });
</script>
